<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head th:replace="~{layout/layout_fragment :: head('Chi tiết hồ sơ')}"></head>

<body class="d-flex flex-column min-vh-100">
    <!-- Include Admin Header -->
    <div th:replace="~{layout/layout_fragment :: admin-header}"></div>

    <div class="container-fluid flex-grow-1">
        <div class="row h-100">
            <!-- Sidebar -->
            <div class="col-md-2 col-lg-2 p-0">
                <div th:replace="~{layout/layout_fragment :: admin-sidebar('applications')}"></div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 col-lg-10 p-4">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="h4 mb-1">
                            <i class="bi bi-file-earmark-text"></i> Chi tiết hồ sơ
                        </h2>
                        <p class="text-muted mb-0">
                            Mã hồ sơ: <strong
                                th:text="${applicationDetail != null ? applicationDetail.code : 'N/A'}">CODE_HERE</strong>
                        </p>
                    </div>
                    <div>
                        <a th:href="@{/admin/applications}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Quay lại
                        </a>
                        <button type="button" class="btn btn-danger" 
                            th:data-app-id="${applicationDetail.id}"
                            th:data-app-code="${applicationDetail.code}"
                            onclick="confirmDeleteFromData(this)"
                            sec:authorize="hasAnyAuthority('ROLE_ADMIN', 'ROLE_MANAGER')">
                            <i class="bi bi-trash"></i> Xóa hồ sơ
                        </button>
                    </div>
                </div>

                <!-- Content Row -->
                <div class="row g-3">
                    <!-- Left Column - Application Info -->
                    <div class="col-lg-6">
                        <!-- Application Info Card -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-info-circle"></i> Thông tin hồ sơ
                                </h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                        <tr>
                                            <th width="40%" class="text-muted">
                                                <i class="bi bi-hash"></i> Mã hồ sơ:
                                            </th>
                                            <td>
                                                <strong th:text="${applicationDetail.code}">DEFAULT_CODE</strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th class="text-muted">
                                                <i class="bi bi-calendar-event"></i> Ngày nộp:
                                            </th>
                                            <td
                                                th:text="${applicationDetail.submittedAt != null ? #temporals.format(applicationDetail.submittedAt, 'dd/MM/yyyy HH:mm') : 'N/A'}">
                                                DEFAULT_DATE
                                            </td>
                                        </tr>
                                        <tr>
                                            <th class="text-muted">
                                                <i class="bi bi-info-circle"></i> Trạng thái:
                                            </th>
                                            <td>
                                                <span
                                                    th:if="${applicationDetail.status != null and applicationDetail.status.name() == 'APPROVED'}"
                                                    class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> Đã phê duyệt
                                                </span>
                                                <span
                                                    th:if="${applicationDetail.status != null and applicationDetail.status.name() == 'REJECTED'}"
                                                    class="badge bg-danger">
                                                    <i class="bi bi-x-circle"></i> Đã từ chối
                                                </span>
                                                <span
                                                    th:if="${applicationDetail.status != null and applicationDetail.status.name() == 'PROCESSING'}"
                                                    class="badge bg-warning text-dark">
                                                    <i class="bi bi-hourglass-split"></i> Đang xử lý
                                                </span>
                                                <span
                                                    th:if="${applicationDetail.status != null and applicationDetail.status.name() == 'RECEIVED'}"
                                                    class="badge bg-info">
                                                    <i class="bi bi-inbox"></i> Đã tiếp nhận
                                                </span>
                                                <span th:if="${applicationDetail.status == null}"
                                                    class="badge bg-secondary">
                                                    <i class="bi bi-question-circle"></i> Chưa xác định
                                                </span>
                                            </td>
                                        </tr>
                                        <tr
                                            th:if="${applicationDetail.note != null and !applicationDetail.note.isEmpty()}">
                                            <th class="text-muted">
                                                <i class="bi bi-pencil-square"></i> Ghi chú:
                                            </th>
                                            <td>
                                                <div class="alert alert-info mb-0 py-2">
                                                    <small th:text="${applicationDetail.note}"></small>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Service Info Card -->
                        <div class="card border-0 shadow-sm mb-3" th:if="${applicationDetail.service != null}">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-grid"></i> Thông tin dịch vụ
                                </h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                        <tr>
                                            <th width="40%" class="text-muted">
                                                <i class="bi bi-card-heading"></i> Tên dịch vụ:
                                            </th>
                                            <td>
                                                <strong th:text="${applicationDetail.service.name}"></strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th class="text-muted">
                                                <i class="bi bi-file-text"></i> Mô tả:
                                            </th>
                                            <td th:text="${applicationDetail.service.description}"></td>
                                        </tr>
                                        <tr>
                                            <th class="text-muted">
                                                <i class="bi bi-clock"></i> Thời gian xử lý:
                                            </th>
                                            <td>
                                                <span class="badge bg-warning text-dark">
                                                    <span th:text="${applicationDetail.service.processingTime}"></span>
                                                    ngày
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th class="text-muted">
                                                <i class="bi bi-cash"></i> Phí dịch vụ:
                                            </th>
                                            <td>
                                                <span class="badge bg-success">
                                                    <span
                                                        th:text="${#numbers.formatDecimal(applicationDetail.service.fee, 0, 'COMMA', 0, 'POINT')}"></span>
                                                    VNĐ
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Requirements Card -->
                        <div class="card border-0 shadow-sm"
                            th:if="${applicationDetail.requirements != null and !applicationDetail.requirements.isEmpty()}">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="bi bi-list-check"></i> Yêu cầu hồ sơ
                                </h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item border-0 px-0"
                                        th:each="req : ${applicationDetail.requirements}">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        <span th:text="${req}"></span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Actions & Documents -->
                    <div class="col-lg-6">
                        <!-- Documents Card -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-paperclip"></i> Tài liệu đính kèm
                                </h5>
                            </div>
                            <div class="card-body">
                                <div th:if="${applicationDetail.documents == null or applicationDetail.documents.isEmpty()}"
                                    class="text-center py-4">
                                    <i class="bi bi-inbox display-4 text-muted"></i>
                                    <p class="text-muted mt-2 mb-0">Chưa có tài liệu nào được tải lên</p>
                                </div>
                                <ul class="list-group"
                                    th:if="${applicationDetail.documents != null and !applicationDetail.documents.isEmpty()}">
                                    <li class="list-group-item d-flex justify-content-between align-items-center"
                                        th:each="doc : ${applicationDetail.documents}">
                                        <div>
                                            <i class="bi bi-file-earmark-pdf text-danger fs-4"></i>
                                            <strong th:text="${doc.fileName}"></strong>
                                            <br>
                                            <small class="text-muted">
                                                <i class="bi bi-calendar"></i>
                                                <span
                                                    th:text="${#temporals.format(doc.uploadedAt, 'dd/MM/yyyy HH:mm')}"></span>
                                            </small>
                                        </div>
                                        <a th:href="@{/admin/applications/documents/{docId}/download(docId=${doc.id})}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download"></i> Tải
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Update Status Form -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-pencil-square"></i> Cập nhật trạng thái
                                </h5>
                            </div>
                            <div class="card-body">
                                <form th:action="@{/admin/applications/{id}/update-status(id=${applicationDetail.id})}"
                                    method="post" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="status" class="form-label">
                                            <i class="bi bi-info-circle"></i> Trạng thái mới
                                        </label>
                                        <select class="form-select" id="status" name="status" required>
                                            <option value="RECEIVED"
                                                th:selected="${applicationDetail.status != null and applicationDetail.status.name() == 'RECEIVED'}">
                                                <i class="bi bi-inbox"></i> Đã tiếp nhận
                                            </option>
                                            <option value="PROCESSING"
                                                th:selected="${applicationDetail.status != null and applicationDetail.status.name() == 'PROCESSING'}">
                                                <i class="bi bi-hourglass-split"></i> Đang xử lý
                                            </option>
                                            <option value="APPROVED"
                                                th:selected="${applicationDetail.status != null and applicationDetail.status.name() == 'APPROVED'}">
                                                <i class="bi bi-check-circle"></i> Đã phê duyệt
                                            </option>
                                            <option value="REJECTED"
                                                th:selected="${applicationDetail.status != null and applicationDetail.status.name() == 'REJECTED'}">
                                                <i class="bi bi-x-circle"></i> Đã từ chối
                                            </option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="note" class="form-label">
                                            <i class="bi bi-chat-left-text"></i> Ghi chú / Lý do
                                        </label>
                                        <textarea class="form-control" id="note" name="note" rows="3"
                                            placeholder="Nhập ghi chú hoặc lý do từ chối..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="documents" class="form-label">
                                            <i class="bi bi-file-earmark-arrow-up"></i> Tài liệu phản hồi
                                        </label>
                                        <input class="form-control" type="file" id="documents" name="documents"
                                            multiple>
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i> Có thể tải lên nhiều file
                                        </small>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-check-circle"></i> Cập nhật trạng thái
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Assign Staff Form -->
                        <div class="card" sec:authorize="hasAnyRole('ADMIN', 'MANAGER')">
                            <div class="card-header bg-warning">
                                <h5><i class="fas fa-user-edit"></i> Gán nhân viên</h5>
                            </div>
                            <div class="card-body">
                                <form th:action="@{/admin/applications/{id}/assign-staff(id=${applicationDetail.id})}"
                                    method="post">
                                    <div class="mb-3">
                                        <label for="staffId" class="form-label">Chọn nhân viên</label>
                                        <select class="form-select" id="staffId" name="staffId" required>
                                            <option value="">-- Chọn nhân viên --</option>
                                            <option th:each="staff : ${staffList}" th:value="${staff.id}"
                                                th:selected="${applicationDetail.assignedStaff != null && applicationDetail.assignedStaff.id == staff.id}"
                                                th:text="${staff.email + ' (' + staff.username + ')'}">
                                            </option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="assignNote" class="form-label">Ghi chú</label>
                                        <textarea class="form-control" id="assignNote" name="note" rows="2"
                                            placeholder="Lý do gán hoặc hướng dẫn..."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-warning w-100">
                                        <i class="fas fa-user-check"></i> Gán nhân viên
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="bg-light text-center py-3 mt-auto">
                <div class="container">
                    <p class="text-muted mb-0">
                        &copy; 2024 Public Service Manager. All rights reserved.
                    </p>
                </div>
            </footer>

            <!-- Toast Notifications -->
            <div th:if="${successMessage}" class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
                <div class="toast show align-items-center text-white bg-success border-0" role="alert"
                    aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span th:text="${successMessage}"></span>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                            data-bs-dismiss="toast"></button>
                    </div>
                </div>
            </div>

            <div th:if="${errorMessage}" class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
                <div class="toast show align-items-center text-white bg-danger border-0" role="alert"
                    aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-x-circle-fill me-2"></i>
                            <span th:text="${errorMessage}"></span>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                            data-bs-dismiss="toast"></button>
                    </div>
                </div>
            </div>

            <script>
                // Auto hide toasts after 5 seconds
                document.addEventListener('DOMContentLoaded', function () {
                    var toastElList = [].slice.call(document.querySelectorAll('.toast'))
                    var toastList = toastElList.map(function (toastEl) {
                        return new bootstrap.Toast(toastEl, {
                            autohide: true,
                            delay: 5000
                        })
                    })
                });

                function confirmDeleteFromData(button) {
                    const appId = button.getAttribute('data-app-id');
                    const appCode = button.getAttribute('data-app-code');
                    confirmDelete(appId, appCode);
                }

                function confirmDelete(appId, appCode) {
                    if (confirm(`Bạn có chắc chắn muốn xóa hồ sơ "${appCode}" không?\n\nHồ sơ sẽ bị xóa mềm và không hiển thị trong danh sách nữa.`)) {
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '/admin/applications/' + appId + '/delete';
                        
                        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
                        if (csrfToken) {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = '_csrf';
                            input.value = csrfToken;
                            form.appendChild(input);
                        }
                        
                        document.body.appendChild(form);
                        form.submit();
                    }
                }
            </script>
</body>

</html>