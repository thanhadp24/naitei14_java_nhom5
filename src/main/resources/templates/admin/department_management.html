<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<!-- Include Head Fragment -->
<head th:replace="~{layout/layout_fragment :: head('Quản lý phòng ban')}"></head>

<body class="d-flex flex-column min-vh-100">

    <!-- Include Admin Header -->
    <div th:replace="~{layout/layout_fragment :: admin-header}"></div>

    <div class="container-fluid flex-grow-1">
        <div class="row h-100">
            <!-- Sidebar -->
            <div class="col-md-2 col-lg-2 p-0">
                <div th:replace="~{layout/layout_fragment :: admin-sidebar('departments')}"></div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 col-lg-10 p-4">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="h4 mb-1">Quản lý phòng ban</h2>
                        <p class="text-muted mb-0">Quản lý thông tin các phòng ban trong hệ thống</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-building"></i> Danh sách phòng ban</h5>
                        <div>
                            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#createDepartmentModal">
                                <i class="bi bi-plus-circle"></i> Thêm phòng ban
                            </button>
                            <button class="btn btn-light btn-sm me-2" onclick="exportDepartments()">
                                <i class="bi bi-download"></i> Export CSV
                            </button>
                            <button class="btn btn-warning btn-sm me-2" data-bs-toggle="modal" data-bs-target="#importDepartmentModal">
                                <i class="bi bi-upload"></i> Import CSV
                            </button>

                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Loading -->
                        <div id="loading" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>

                        <!-- Error Alert -->
                        <div id="errorAlert" class="alert alert-danger" style="display: none;"></div>

                        <!-- Departments Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Mã phòng ban</th>
                                        <th>Tên phòng ban</th>
                                        <th>Trưởng phòng</th>
                                        <th>Địa chỉ</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="departmentTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav>
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination buttons will be loaded here -->
                            </ul>
                        </nav>

                        <!-- Stats -->
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <strong>Tổng số:</strong> <span id="totalElements">0</span> phòng ban |
                                    <strong>Trang:</strong> <span id="currentPage">1</span>/<span id="totalPages">1</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Create Department -->
    <div class="modal fade" id="createDepartmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Thêm phòng ban mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createDepartmentForm">
                        <div class="mb-3">
                            <label class="form-label">Mã phòng ban <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="code" placeholder="VD: IT, HR, SALES">
                            <div class="invalid-feedback" id="codeError"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tên phòng ban <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" placeholder="VD: Phòng Công nghệ thông tin">
                            <div class="invalid-feedback" id="nameError"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Trưởng phòng</label>
                            <select class="form-select" id="leaderId">
                                <option value="">Chọn trưởng phòng</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Địa chỉ</label>
                            <input type="text" class="form-control" id="address" placeholder="Tầng 3, Tòa nhà A">
                        </div>
                        <div class="alert alert-danger" id="createErrorAlert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="createDepartment()">
                        <i class="bi bi-save"></i> Tạo mới
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Import Department -->
    <div class="modal fade" id="importDepartmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-upload"></i> Import danh sách phòng ban từ CSV</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="bi bi-info-circle"></i> Hướng dẫn</h6>
                        <p class="mb-2">File CSV phải tuân theo định dạng sau:</p>
                        <ul class="mb-0">
                            <li>Dòng đầu tiên là tiêu đề (sẽ bị bỏ qua khi import)</li>
                            <li>Mỗi dòng tiếp theo chứa thông tin một phòng ban</li>
                            <li>Các trường được phân cách bằng dấu phẩy (,)</li>
                            <li><strong>Nếu mã phòng ban đã tồn tại, phòng ban đó sẽ bị bỏ qua</strong></li>
                        </ul>
                    </div>
                    
                    <h6 class="mt-3">Mẫu file CSV chuẩn:</h6>
                    <div class="border rounded p-3 bg-light font-monospace" style="font-size: 0.9em;">
                        <div>Mã phòng ban,Tên phòng ban,Địa chỉ</div>
                        <div class="text-muted">IT,Phòng Công nghệ thông tin,Tầng 3</div>
                        <div class="text-muted">HR,Phòng Nhân sự,Tầng 2</div>
                        <div class="text-muted">SALES,Phòng Kinh doanh,Tầng 1</div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label"><strong>Chọn file CSV:</strong></label>
                        <input type="file" class="form-control" id="importFileInput" accept=".csv">
                        <div class="form-text">Chỉ chấp nhận file có định dạng .csv</div>
                    </div>

                    <div class="alert alert-danger mt-3" id="importErrorAlert" style="display: none;"></div>
                    <div class="alert alert-success mt-3" id="importSuccessAlert" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-warning" onclick="processImport()">
                        <i class="bi bi-upload"></i> Thực hiện Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit Department -->
    <div class="modal fade" id="editDepartmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Sửa thông tin phòng ban</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editDepartmentForm">
                        <input type="hidden" id="editDepartmentId">
                        <div class="mb-3">
                            <label class="form-label">Mã phòng ban <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editCode">
                            <div class="invalid-feedback" id="editCodeError"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tên phòng ban <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editName">
                            <div class="invalid-feedback" id="editNameError"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Trưởng phòng</label>
                            <select class="form-select" id="editLeaderId">
                                <option value="">Chọn trưởng phòng</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Địa chỉ</label>
                            <input type="text" class="form-control" id="editAddress">
                        </div>
                        <div class="alert alert-danger" id="editErrorAlert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-warning" onclick="updateDepartment()">
                        <i class="bi bi-save"></i> Cập nhật
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 0;
        const pageSize = 10;

        document.addEventListener('DOMContentLoaded', function() {
            loadDepartments();
            loadUsers();
        });

        function loadDepartments(page = 0) {
            currentPage = page;

            let params = new URLSearchParams({
                page: page,
                size: pageSize,
                sortBy: 'id',
                sortDir: 'ASC'
            });

            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorAlert').style.display = 'none';

            fetch(`/api/v1/admin/departments?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể tải dữ liệu. Vui lòng thử lại!');
                }
                return response.json();
            })
            .then(data => {
                const pageData = data.data ? data.data : data;
                displayDepartments(pageData.content || []);
                displayPagination(pageData);
                updateStats(pageData);
            })
            .catch(error => {
                document.getElementById('errorAlert').textContent = error.message;
                document.getElementById('errorAlert').style.display = 'block';
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none';
            });
        }

        function displayDepartments(departments) {
            const tbody = document.getElementById('departmentTableBody');
            tbody.innerHTML = '';

            if (!departments || departments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Không có dữ liệu</td></tr>';
                return;
            }

            departments.forEach(dept => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dept.id}</td>
                    <td><strong>${dept.code || '-'}</strong></td>
                    <td>${dept.name || '-'}</td>
                    <td>${dept.leaderName ? '<span class="badge bg-primary">' + dept.leaderName + '</span>' : '<span class="text-muted">Chưa có</span>'}</td>
                    <td>${dept.address || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="openEditModal(${dept.id})" title="Sửa">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDepartment(${dept.id})" title="Xóa">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayPagination(data) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (!data) return;

            const totalPages = data.totalPages || 0;
            const currentPage = data.number || 0;

            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadDepartments(${currentPage - 1}); return false;">Trước</a>`;
            pagination.appendChild(prevLi);

            for (let i = 0; i < totalPages; i++) {
                if (i === 0 || i === totalPages - 1 || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="loadDepartments(${i}); return false;">${i + 1}</a>`;
                    pagination.appendChild(li);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<a class="page-link" href="#">...</a>';
                    pagination.appendChild(li);
                }
            }

            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadDepartments(${currentPage + 1}); return false;">Sau</a>`;
            pagination.appendChild(nextLi);
        }

        function updateStats(data) {
            if (!data) return;
            document.getElementById('totalElements').textContent = data.totalElements || 0;
            document.getElementById('currentPage').textContent = (data.number || 0) + 1;
            document.getElementById('totalPages').textContent = data.totalPages || 0;
        }

        function clearValidationErrors() {
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
            document.getElementById('createErrorAlert').style.display = 'none';
            document.getElementById('editErrorAlert').style.display = 'none';
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            if (field && errorDiv) {
                field.classList.add('is-invalid');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function loadUsers() {
            fetch('/api/v1/admin/users/all')
                .then(response => response.json())
                .then(data => {
                    const users = data.data || data;
                    const createSelect = document.getElementById('leaderId');
                    
                    createSelect.innerHTML = '<option value="">Chọn trưởng phòng</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        createSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading users:', error));
        }

        function loadUsersByDepartment(departmentId) {
            return fetch(`/api/v1/admin/users/by-department/${departmentId}`)
                .then(response => response.json())
                .then(data => {
                    const users = data.data || data;
                    const editSelect = document.getElementById('editLeaderId');
                    
                    editSelect.innerHTML = '<option value="">Chọn trưởng phòng</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        editSelect.appendChild(option);
                    });
                    return users;
                })
                .catch(error => {
                    console.error('Error loading users by department:', error);
                    return [];
                });
        }

        function createDepartment() {
            clearValidationErrors();

            const leaderId = document.getElementById('leaderId').value;
            const data = {
                code: document.getElementById('code').value.trim(),
                name: document.getElementById('name').value.trim(),
                address: document.getElementById('address').value.trim(),
                leaderId: leaderId ? parseInt(leaderId) : null
            };

            let hasError = false;
            if (!data.code) {
                showFieldError('code', 'Mã phòng ban không được để trống');
                hasError = true;
            }
            if (!data.name) {
                showFieldError('name', 'Tên phòng ban không được để trống');
                hasError = true;
            }

            if (hasError) return;

            const errorAlert = document.getElementById('createErrorAlert');

            fetch('/api/v1/admin/departments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        const errorMessage = err.message || err.error || 'Có lỗi xảy ra!';
                        errorAlert.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${errorMessage}`;
                        errorAlert.style.display = 'block';
                        throw new Error('Validation failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('createDepartmentModal'));
                modal.hide();
                document.getElementById('createDepartmentForm').reset();
                clearValidationErrors();
                loadDepartments(0);
                alert('Tạo phòng ban thành công!');
            })
            .catch(error => {
                if (error.message !== 'Validation failed') {
                    errorAlert.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${error.message}`;
                    errorAlert.style.display = 'block';
                }
            });
        }

        function openEditModal(deptId) {
            fetch(`/api/v1/admin/departments/${deptId}`)
                .then(response => response.json())
                .then(data => {
                    const dept = data.data ? data.data : data;
                    
                    document.getElementById('editDepartmentId').value = dept.id;
                    document.getElementById('editCode').value = dept.code || '';
                    document.getElementById('editName').value = dept.name || '';
                    document.getElementById('editAddress').value = dept.address || '';
                    
                    // Load users theo department ID, sau đó set giá trị leader
                    loadUsersByDepartment(dept.id).then(() => {
                        document.getElementById('editLeaderId').value = dept.leaderId || '';
                    });
                    
                    clearValidationErrors();
                    
                    const modal = new bootstrap.Modal(document.getElementById('editDepartmentModal'));
                    modal.show();
                })
                .catch(error => {
                    alert('Không thể tải thông tin phòng ban: ' + error.message);
                });
        }

        function updateDepartment() {
            clearValidationErrors();

            const deptId = document.getElementById('editDepartmentId').value;
            const leaderId = document.getElementById('editLeaderId').value;
            const data = {
                code: document.getElementById('editCode').value.trim(),
                name: document.getElementById('editName').value.trim(),
                address: document.getElementById('editAddress').value.trim(),
                leaderId: leaderId ? parseInt(leaderId) : null
            };

            let hasError = false;
            if (!data.code) {
                showFieldError('editCode', 'Mã phòng ban không được để trống');
                hasError = true;
            }
            if (!data.name) {
                showFieldError('editName', 'Tên phòng ban không được để trống');
                hasError = true;
            }

            if (hasError) return;

            const errorAlert = document.getElementById('editErrorAlert');

            fetch(`/api/v1/admin/departments/${deptId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        const errorMessage = err.message || err.error || 'Có lỗi xảy ra!';
                        errorAlert.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${errorMessage}`;
                        errorAlert.style.display = 'block';
                        throw new Error('Validation failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editDepartmentModal'));
                modal.hide();
                loadDepartments(currentPage);
                alert('Cập nhật phòng ban thành công!');
            })
            .catch(error => {
                if (error.message !== 'Validation failed') {
                    errorAlert.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${error.message}`;
                    errorAlert.style.display = 'block';
                }
            });
        }

        function deleteDepartment(deptId) {
            if (!confirm('Bạn có chắc chắn muốn xóa phòng ban này? Hành động này không thể hoàn tác!')) {
                return;
            }

            fetch(`/api/v1/admin/departments/${deptId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể xóa phòng ban!');
                }
                alert('Xóa phòng ban thành công!');
                loadDepartments(currentPage);
            })
            .catch(error => {
                alert(error.message);
            });
        }

        function exportDepartments() {
            if (!confirm('Bạn có chắc chắn muốn xuất danh sách phòng ban ra file CSV?')) {
                return;
            }

            window.location.href = '/api/v1/admin/departments/export';
        }

        function processImport() {
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];
            const errorAlert = document.getElementById('importErrorAlert');
            const successAlert = document.getElementById('importSuccessAlert');

            // Hide alerts
            errorAlert.style.display = 'none';
            successAlert.style.display = 'none';

            if (!file) {
                errorAlert.textContent = 'Vui lòng chọn file CSV để import!';
                errorAlert.style.display = 'block';
                return;
            }

            if (!file.name.endsWith('.csv')) {
                errorAlert.textContent = 'Chỉ chấp nhận file CSV!';
                errorAlert.style.display = 'block';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            document.getElementById('loading').style.display = 'block';

            fetch('/api/v1/admin/departments/import', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'Import thất bại');
                    });
                }
                return response.json();
            })
            .then(data => {
                const result = data.data || data;
                successAlert.innerHTML = `
                    <strong>Import thành công!</strong><br>
                    <ul class="mb-0 mt-2">
                        <li>Đã thêm: ${result.added} phòng ban</li>
                        <li>Bỏ qua (đã tồn tại): ${result.skipped} phòng ban</li>
                        <li>Lỗi: ${result.errors} dòng</li>
                    </ul>
                `;
                successAlert.style.display = 'block';
                fileInput.value = ''; // Reset file input
                loadDepartments(0);
            })
            .catch(error => {
                errorAlert.textContent = 'Lỗi khi import: ' + error.message;
                errorAlert.style.display = 'block';
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none';
            });
        }
    </script>
</body>
</html>
