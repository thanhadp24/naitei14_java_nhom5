<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout/layout_fragment :: head('Quản lý loại dịch vụ')}"></head>

<body class="d-flex flex-column min-vh-100">

    <div th:replace="~{layout/layout_fragment :: admin-header}"></div>

    <div class="container-fluid flex-grow-1">
        <div class="row h-100">
            <div class="col-md-2 col-lg-2 p-0">
                <div th:replace="~{layout/layout_fragment :: admin-sidebar('servicetypes')}"></div>
            </div>

            <div class="col-md-10 col-lg-10 p-4">
                <div class="container-fluid">
                    <div class="card">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-tags-fill"></i> Quản lý Loại Dịch vụ</h5>
                            <div>
                                <a th:href="@{/admin/servicetypes/new}" class="btn btn-primary btn-sm">
                                    <i class="bi bi-plus-circle"></i> Tạo Loại mới
                                </a>
                                <a href="servicetypes/export" class="btn btn-light btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </a>
                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#importModal">
                                    <i class="bi bi-file-earmark-arrow-up"></i> Import CSV
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}">
                            </div>
                            <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Category</th>
                                            <th>Mô tả</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="type : ${serviceTypes}">
                                            <td th:text="${type.id}"></td>
                                            <td>
                                                <a th:href="@{/admin/services(serviceTypeId=${type.id})}" 
                                                   class="text-decoration-none fw-bold text-primary"
                                                   th:text="${type.category}"
                                                   title="Xem danh sách dịch vụ">
                                                </a>
                                            </td>
                                            <td th:text="${type.description}"></td>
                                            <td>
                                                <a th:href="@{/admin/servicetypes/edit/{id}(id=${type.id})}"
                                                    class="btn btn-sm btn-outline-primary" title="Chỉnh sửa">
                                                    <i class="bi bi-pencil-square"></i>
                                                </a>
                                                <a th:href="@{/admin/servicetypes/delete/{id}(id=${type.id})}"
                                                    class="btn btn-sm btn-outline-danger" title="Xóa"
                                                    onclick="return confirm('Bạn có chắc chắn muốn xóa loại dịch vụ này?');">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        <tr th:if="${serviceTypes.isEmpty()}">
                                            <td colspan="4" class="text-center">Chưa có loại dịch vụ nào.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import Modal -->
                <div class="modal fade" id="importModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-file-earmark-arrow-up"></i> Import Loại Dịch Vụ từ CSV
                                </h5>
                                <button type="button" class="btn-close btn-close-white"
                                    data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Instructions -->
                                <div class="alert alert-info">
                                    <h6 class="alert-heading"><i class="bi bi-info-circle"></i> Hướng dẫn Import CSV:
                                    </h6>
                                    <ul class="mb-2">
                                        <li><strong>Định dạng:</strong> File CSV với encoding UTF-8</li>
                                        <li><strong>Header:</strong> <code>category,description</code></li>
                                        <li><strong>Category:</strong> Bắt buộc, tối đa 150 ký tự, không trùng lặp</li>
                                        <li><strong>Description:</strong> Tùy chọn, mô tả chi tiết về loại dịch vụ</li>
                                    </ul>
                                    <p class="mb-0"><strong>Lưu ý:</strong> Các category đã tồn tại sẽ bị bỏ qua.</p>
                                </div>

                                <!-- Upload Form -->
                                <form id="importForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label class="form-label">Chọn file CSV <span
                                                class="text-danger">*</span></label>
                                        <input type="file" class="form-control" id="csvFileInput" accept=".csv"
                                            required>
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i> Chỉ chấp nhận file .csv với encoding UTF-8
                                        </small>
                                    </div>
                                </form>

                                <!-- Download Template -->
                                <div class="mb-3">
                                    <button onclick="downloadTemplate()" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-download"></i> Tải file mẫu
                                    </button>
                                </div>

                                <!-- Import Result -->
                                <div id="importResultAlert" style="display: none;"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> Đóng
                                </button>
                                <button type="button" class="btn btn-success" onclick="importFromCsv()">
                                    <i class="bi bi-upload"></i> Import
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
                <script>
                    // Import service types from CSV
                    function importFromCsv() {
                        const fileInput = document.getElementById('csvFileInput');
                        const file = fileInput.files[0];
                        const resultAlert = document.getElementById('importResultAlert');

                        // Validate file selected
                        if (!file) {
                            alert('Vui lòng chọn file!');
                            return;
                        }

                        // Validate file type
                        if (!file.name.endsWith('.csv')) {
                            alert('Chỉ chấp nhận file CSV!');
                            return;
                        }

                        // Validate file size (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('File không được vượt quá 5MB!');
                            return;
                        }

                        const formData = new FormData();
                        formData.append('file', file);

                        // Show loading
                        resultAlert.innerHTML = `
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <strong>Đang xử lý file...</strong> Vui lòng đợi.
        </div>`;
                        resultAlert.style.display = 'block';

                        // Disable import button
                        const importBtn = event.target;
                        importBtn.disabled = true;
                        importBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang import...';

                        fetch('/servicetypes/import', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => {
                                if (!response.ok) {
                                    return response.json().then(err => {
                                        throw new Error(err.message || 'Có lỗi xảy ra khi import!');
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Import result:', data);

                                let alertClass = 'success';
                                let icon = 'check-circle-fill';
                                let title = 'Import thành công!';

                                // Build result message
                                let message = `
            <div class="alert alert-${alertClass}">
                <i class="bi bi-${icon}"></i> 
                <h6><strong>${title}</strong></h6>
                <ul class="mb-2">
                    <li>Tổng số dòng: <strong>${data.total}</strong></li>
                    <li>Thành công: <strong class="text-success">${data.success}</strong></li>
                    <li>Thất bại: <strong class="text-danger">${data.failed}</strong></li>
                </ul>`;

                                // Show errors if any
                                if (data.errors && data.errors.length > 0) {
                                    message += `
                <div class="mt-2">
                    <strong>Chi tiết lỗi:</strong>
                    <ul class="mb-0" style="max-height: 200px; overflow-y: auto;">`;
                                    data.errors.forEach(error => {
                                        message += `<li class="text-danger">${error}</li>`;
                                    });
                                    message += `</ul>
                </div>`;
                                }

                                message += `</div>`;
                                resultAlert.innerHTML = message;

                                // Reload page if any success
                                if (data.success > 0) {
                                    setTimeout(() => {
                                        location.reload();
                                    }, 2000);
                                }
                            })
                            .catch(error => {
                                console.error('Import error:', error);
                                resultAlert.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle-fill"></i> 
                <h6><strong>Có lỗi xảy ra!</strong></h6>
                <p class="mb-0">${error.message}</p>
            </div>`;
                            })
                            .finally(() => {
                                // Re-enable import button
                                importBtn.disabled = false;
                                importBtn.innerHTML = '<i class="bi bi-upload"></i> Import';
                            });
                    }

                    // Download CSV template
                    function downloadTemplate() {
                        const csvContent =
                            `category,description
Giấy tờ tùy thân,"Dịch vụ cấp các loại giấy tờ tùy thân như CMND, CCCD"
Hộ khẩu,"Dịch vụ đăng ký thường trú, tạm trú"
Hộ tịch,"Dịch vụ khai sinh, khai tử, đăng ký kết hôn"
Đất đai,"Dịch vụ cấp sổ đỏ, giấy chứng nhận quyền sử dụng đất"
Xây dựng,"Dịch vụ cấp phép xây dựng, sửa chữa nhà"`;

                        // Create blob with UTF-8 BOM
                        const blob = new Blob(['\ufeff' + csvContent], {
                            type: 'text/csv;charset=utf-8;'
                        });

                        const link = document.createElement("a");
                        const url = URL.createObjectURL(blob);

                        link.setAttribute("href", url);
                        link.setAttribute("download", "service_type_template.csv");
                        link.style.visibility = 'hidden';

                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        // Show success message
                        setTimeout(() => {
                            alert('✓ File mẫu đã được tải xuống!');
                        }, 100);
                    }

                    // Clear import modal when closed
                    document.getElementById('importModal').addEventListener('hidden.bs.modal', function () {
                        document.getElementById('importForm').reset();
                        document.getElementById('importResultAlert').style.display = 'none';
                    });
                </script>
            </div>
        </div>
    </div>

    <div th:replace="~{layout/layout_fragment :: admin-footer}"></div>
    <div th:replace="~{layout/layout_fragment :: scripts}"></div>
</body>

</html>