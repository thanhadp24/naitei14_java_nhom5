<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<!-- Include Head Fragment -->
<head th:replace="~{layout/layout_fragment :: head('Chi tiết người dùng')}"></head>

<body class="d-flex flex-column min-vh-100">

    <!-- Include Admin Header -->
    <div th:replace="~{layout/layout_fragment :: admin-header}"></div>

    <div class="container-fluid flex-grow-1">
        <div class="row h-100">
            <!-- Sidebar -->
            <div class="col-md-2 col-lg-2 p-0">
                <div th:replace="~{layout/layout_fragment :: admin-sidebar('users')}"></div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 col-lg-10 p-4">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="h4 mb-1">Chi tiết người dùng</h2>
                        <p class="text-muted mb-0">Thông tin chi tiết tài khoản nhân viên</p>
                    </div>
                    <a href="/admin/users" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Quay lại danh sách
                    </a>
                </div>

                <div class="card">
                    <div class="card-body">
                        <!-- Loading -->
                        <div id="loading" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>

                        <!-- Error Alert -->
                        <div id="errorAlert" class="alert alert-danger" style="display: none;"></div>

                        <!-- User Detail Content -->
                        <div id="userDetailContent" style="display: none;">
                            <div class="row">
                                <!-- Left Column: Basic Info -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0"><i class="bi bi-info-circle"></i> Thông tin cơ bản</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-borderless">
                                                <tbody>
                                                    <tr>
                                                        <th width="40%">ID:</th>
                                                        <td id="userId"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Loại tài khoản:</th>
                                                        <td id="userType"></td>
                                                    </tr>
                                                    <tr id="usernameRow" style="display: none;">
                                                        <th>Username:</th>
                                                        <td id="username"></td>
                                                    </tr>
                                                    <tr id="nationalIdRow" style="display: none;">
                                                        <th>CMND/CCCD:</th>
                                                        <td id="nationalId"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Họ và tên:</th>
                                                        <td id="fullName"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Email:</th>
                                                        <td id="email"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Số điện thoại:</th>
                                                        <td id="phone"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Địa chỉ:</th>
                                                        <td id="address"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column: Additional Info -->
                                <div class="col-md-6">
                                    <!-- User Specific Info -->
                                    <div class="card mb-3" id="userSpecificCard" style="display: none;">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0"><i class="bi bi-shield-check"></i> Thông tin nhân viên</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-borderless">
                                                <tbody>
                                                    <tr>
                                                        <th width="40%">Vai trò:</th>
                                                        <td id="roles"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Phòng ban:</th>
                                                        <td id="departmentName"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Trạng thái:</th>
                                                        <td id="activeStatus"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Citizen Specific Info -->
                                    <div class="card mb-3" id="citizenSpecificCard" style="display: none;">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="bi bi-person-badge"></i> Thông tin công dân</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-borderless">
                                                <tbody>
                                                    <tr>
                                                        <th width="40%">Ngày sinh:</th>
                                                        <td id="dateOfBirth"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Giới tính:</th>
                                                        <td id="gender"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Timestamps -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-secondary text-white">
                                            <h6 class="mb-0"><i class="bi bi-clock-history"></i> Thông tin hệ thống</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-borderless">
                                                <tbody>
                                                    <tr>
                                                        <th width="40%">Ngày tạo:</th>
                                                        <td id="createdAt"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        const userId = /*[[${userId}]]*/ '';
        const userType = /*[[${userType}]]*/ '';

        document.addEventListener('DOMContentLoaded', function() {
            loadUserDetail();
        });

        function loadUserDetail() {
            fetch(`/api/v1/admin/users/${userId}?type=${userType}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Không thể tải thông tin người dùng');
                    }
                    return response.json();
                })
                .then(response => {
                    console.log('User Detail:', response);
                    // API có wrapper {data, message, status}
                    const user = response.data ? response.data : response;
                    displayUserDetail(user);
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('errorAlert').textContent = error.message;
                    document.getElementById('errorAlert').style.display = 'block';
                });
        }

        function displayUserDetail(user) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('userDetailContent').style.display = 'block';

            // Basic Info
            document.getElementById('userId').textContent = user.id || '-';
            document.getElementById('fullName').textContent = user.fullName || '-';
            document.getElementById('email').textContent = user.email || '-';
            document.getElementById('phone').textContent = user.phone || '-';
            document.getElementById('address').textContent = user.address || '-';

            // Type Badge
            const typeBadge = user.type === 'USER' 
                ? '<span class="badge bg-primary">Nhân viên</span>'
                : '<span class="badge bg-info">Công dân</span>';
            document.getElementById('userType').innerHTML = typeBadge;

            // Timestamps
            const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleString('vi-VN') : '-';
            document.getElementById('createdAt').textContent = createdAt;

            // Type Specific Info
            if (user.type === 'USER') {
                document.getElementById('usernameRow').style.display = 'table-row';
                document.getElementById('username').textContent = user.username || '-';
                
                document.getElementById('userSpecificCard').style.display = 'block';
                
                // Roles
                const roles = user.roles && user.roles.length > 0
                    ? user.roles.map(r => `<span class="badge bg-success">${r}</span>`).join(' ')
                    : '-';
                document.getElementById('roles').innerHTML = roles;
                
                document.getElementById('departmentName').textContent = user.departmentName || '-';
                
                const activeStatus = user.active === true
                    ? '<span class="badge bg-success">Đang hoạt động</span>'
                    : '<span class="badge bg-danger">Không hoạt động</span>';
                document.getElementById('activeStatus').innerHTML = activeStatus;
            } else if (user.type === 'CITIZEN') {
                document.getElementById('nationalIdRow').style.display = 'table-row';
                document.getElementById('nationalId').textContent = user.nationalId || '-';
                
                document.getElementById('citizenSpecificCard').style.display = 'block';
                
                const dob = user.dateOfBirth ? new Date(user.dateOfBirth).toLocaleDateString('vi-VN') : '-';
                document.getElementById('dateOfBirth').textContent = dob;
                
                const genderMap = {
                    'MALE': 'Nam',
                    'FEMALE': 'Nữ',
                    'OTHER': 'Khác'
                };
                document.getElementById('gender').textContent = genderMap[user.gender] || user.gender || '-';
            }
        }
    </script>
</body>
</html>
