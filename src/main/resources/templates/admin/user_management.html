<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<!-- Include Head Fragment -->

<head th:replace="~{layout/layout_fragment :: head('Quản lý người dùng')}"></head>

<body class="d-flex flex-column min-vh-100">

    <!-- Include Admin Header -->
    <div th:replace="~{layout/layout_fragment :: admin-header}"></div>

    <div class="container-fluid flex-grow-1">
        <div class="row h-100">
            <!-- Sidebar -->
            <div class="col-md-2 col-lg-2 p-0">
                <div th:replace="~{layout/layout_fragment :: admin-sidebar('users')}"></div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 col-lg-10 p-4">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="h4 mb-1">Quản lý người dùng</h2>
                        <p class="text-muted mb-0">Quản lý tài khoản nhân viên hệ thống</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people-fill"></i> Quản lý người dùng</h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal"
                                data-bs-target="#createUserModal">
                                <i class="bi bi-plus-circle"></i> Thêm người dùng
                            </button>
                            <a href="/api/v1/admin/users/export" class="btn btn-light btn-sm">
                                <i class="bi bi-arrow-left"></i> Export Csv
                            </a>
                            <button class="btn btn-warning btn-sm me-2" data-bs-toggle="modal"
                                data-bs-target="#importStaffModal">
                                <i class="bi bi-file-earmark-arrow-up"></i> Import CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Vai trò</label>
                                <select class="form-select" id="filterRole">
                                    <option value="">Tất cả</option>
                                    <option value="ROLE_ADMIN">Admin</option>
                                    <option value="ROLE_MANAGER">Manager</option>
                                    <option value="ROLE_STAFF">Staff</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Trạng thái</label>
                                <select class="form-select" id="filterActive">
                                    <option value="">Tất cả</option>
                                    <option value="true">Đang hoạt động</option>
                                    <option value="false">Không hoạt động</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Phòng ban</label>
                                <select class="form-select" onchange="loadUsers(0)" id="filterDepartmentId">
                                    <option value="">Tất cả phòng ban</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Tìm kiếm</label>
                                <input type="text" class="form-control" id="filterSearch"
                                    placeholder="Username, email, số điện thoại...">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" onclick="loadUsers()">
                                    <i class="bi bi-search"></i> Tìm kiếm
                                </button>
                                <button class="btn btn-secondary" onclick="resetFilters()">
                                    <i class="bi bi-arrow-clockwise"></i> Reset
                                </button>
                            </div>
                        </div>

                        <!-- Loading -->
                        <div id="loading" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>

                        <!-- Error Alert -->
                        <div id="errorAlert" class="alert alert-danger" style="display: none;"></div>

                        <!-- Users Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Vai trò</th>
                                        <th>Phòng ban</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav>
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination buttons will be loaded here -->
                            </ul>
                        </nav>

                        <!-- Stats -->
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <strong>Tổng số:</strong> <span id="totalElements">0</span> người dùng |
                                    <strong>Trang:</strong> <span id="currentPage">1</span>/<span
                                        id="totalPages">1</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Create User -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-person-plus"></i> Thêm người dùng mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <!-- Form cho User -->
                        <div id="userForm">
                            <h6 class="text-primary mb-3">Thông tin nhân viên</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Username <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="username" placeholder="admin123">
                                    <div class="invalid-feedback" id="usernameError"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="userEmail"
                                        placeholder="user@company.com">
                                    <div class="invalid-feedback" id="emailError"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="userPhone" placeholder="0912345678">
                                    <div class="invalid-feedback" id="phoneError"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Mật khẩu <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="userPassword"
                                        placeholder="Tối thiểu 6 ký tự">
                                    <div class="invalid-feedback" id="passwordError"></div>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Địa chỉ</label>
                                    <input type="text" class="form-control" id="userAddress" placeholder="Hà Nội">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phòng ban</label>
                                    <select class="form-select" id="departmentId">
                                        <option value="">Chọn phòng ban</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Vai trò <span class="text-danger">*</span></label>
                                    <div class="mt-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="userRole" value="1"
                                                id="roleAdmin">
                                            <label class="form-check-label" for="roleAdmin">
                                                <i class="bi bi-shield-fill-check text-danger"></i> Admin
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="userRole" value="2"
                                                id="roleStaff">
                                            <label class="form-check-label" for="roleStaff">
                                                <i class="bi bi-person-badge-fill text-warning"></i> Manager
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="userRole" value="3"
                                                id="roleStaff">
                                            <label class="form-check-label" for="roleStaff">
                                                <i class="bi bi-person-badge text-primary"></i> Staff
                                            </label>
                                        </div>
                                    </div>
                                    <small class="text-muted">Chọn một vai trò</small>
                                    <div class="invalid-feedback" id="roleError" style="display: block;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-danger" id="createErrorAlert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">
                        <i class="bi bi-save"></i> Tạo tài khoản
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit User -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Sửa thông tin người dùng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Username <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editUsername">
                                <div class="invalid-feedback" id="editUsernameError"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="editEmail">
                                <div class="invalid-feedback" id="editEmailError"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="editPhone">
                                <div class="invalid-feedback" id="editPhoneError"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mật khẩu mới</label>
                                <input type="password" class="form-control" id="editPassword"
                                    placeholder="Để trống nếu không đổi">
                                <div class="invalid-feedback" id="editPasswordError"></div>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Địa chỉ</label>
                                <input type="text" class="form-control" id="editAddress">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Phòng ban</label>
                                <select class="form-select" id="editDepartmentId">
                                    <option value="">Chọn phòng ban</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Vai trò <span class="text-danger">*</span></label>
                                <div class="mt-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="editUserRole" value="1"
                                            id="editRoleAdmin">
                                        <label class="form-check-label" for="editRoleAdmin">
                                            <i class="bi bi-shield-fill-check text-danger"></i> Admin
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="editUserRole" value="2"
                                            id="editRoleStaff">
                                        <label class="form-check-label" for="editRoleStaff">
                                            <i class="bi bi-person-badge-fill text-warning"></i> Manager
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="editUserRole" value="3"
                                            id="editRoleStaff">
                                        <label class="form-check-label" for="editRoleStaff">
                                            <i class="bi bi-person-badge text-primary"></i> Staff
                                        </label>
                                    </div>
                                </div>
                                <div class="invalid-feedback" id="editRoleError" style="display: block;"></div>
                            </div>
                        </div>
                        <div class="alert alert-danger" id="editErrorAlert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-warning" onclick="updateUser()">
                        <i class="bi bi-save"></i> Cập nhật
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Staff Modal -->
    <div class="modal fade" id="importStaffModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-arrow-up"></i> Import Danh Sách Staff
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Instructions -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="bi bi-info-circle"></i> Hướng dẫn Import CSV:</h6>
                        <ul class="mb-2">
                            <li><strong>Định dạng:</strong>
                                <code>username,email,phone,address,departmentId</code>
                            </li>
                            <li><strong>username</strong>: Tên đăng nhập (bắt buộc, ít nhất 3 ký tự, duy nhất)</li>
                            <li><strong>email</strong>: Email (bắt buộc, định dạng hợp lệ, duy nhất)</li>
                            <li><strong>phone</strong>: Số điện thoại (bắt buộc, 10-11 chữ số)</li>
                            <li><strong>address</strong>: Địa chỉ (không bắt buộc, nếu có dấu phẩy thì đặt trong dấu
                                ngoặc kép)</li>
                            <li><strong>departmentId</strong>: ID phòng ban (không bắt buộc, để trống nếu không có)</li>
                        </ul>
                        <div class="alert alert-warning mb-0">
                            <strong>Lưu ý:</strong>
                            <ul class="mb-0">
                                <li>File phải có encoding <strong>UTF-8</strong></li>
                                <li>Địa chỉ có dấu phẩy phải đặt trong dấu ngoặc kép:
                                    <code>"123 Nguyen Trai, District 1"</code>
                                </li>
                                <li>DepartmentId phải là số nguyên hợp lệ hoặc để trống</li>
                                <li><strong>Mật khẩu mặc định:</strong> <code>username@123</code> (VD: nguyenvana@123)
                                </li>
                                <li>Vai trò mặc định: <span class="badge bg-primary">Staff</span></li>
                                <li>Tài khoản mặc định: <span class="badge bg-success">Active</span></li>
                            </ul>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <form id="importStaffForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label">Chọn file CSV <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="csvFileInput" accept=".csv" required>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Chỉ chấp nhận file .csv với encoding UTF-8
                            </small>
                        </div>
                    </form>

                    <!-- Download Template -->
                    <div class="mb-3">
                        <button onclick="downloadTemplate()" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-download"></i> Tải file mẫu
                        </button>
                    </div>

                    <!-- Import Result -->
                    <div id="importResultAlert" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Đóng
                    </button>
                    <button type="button" class="btn btn-success" onclick="importStaffFromCsv()">
                        <i class="bi bi-upload"></i> Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 0;
        const pageSize = 10;

        // Load users on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadUsers();
            loadDepartments();
        });

        function loadUsers(page = 0) {
            currentPage = page;
            const role = document.getElementById('filterRole').value;
            const active = document.getElementById('filterActive').value;
            const search = document.getElementById('filterSearch').value;
            const departmentId = document.getElementById('filterDepartmentId').value;

            // Build query params
            let params = new URLSearchParams({
                page: page,
                size: pageSize,
                sortBy: 'createdAt',
                sortDir: 'DESC',
                type: 'USER' // Chỉ lấy User
            });

            if (role) params.append('role', role);
            if (active) params.append('active', active);
            if (search) params.append('search', search);
            if (departmentId) params.append('departmentId', departmentId);

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorAlert').style.display = 'none';

            // Fetch data
            fetch(`/api/v1/admin/users?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Không thể tải dữ liệu. Vui lòng thử lại!');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API Response:', data); // Debug

                    // API trả về Page trực tiếp, không có wrapper
                    const pageData = data.data ? data.data : data;

                    displayUsers(pageData.content || []);
                    displayPagination(pageData);
                    updateStats(pageData);
                })
                .catch(error => {
                    document.getElementById('errorAlert').textContent = error.message;
                    document.getElementById('errorAlert').style.display = 'block';
                })
                .finally(() => {
                    document.getElementById('loading').style.display = 'none';
                });
        }

        function displayUsers(users) {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Không có dữ liệu</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');

                // Roles
                const roles = user.roles && user.roles.length > 0
                    ? user.roles.map(r => `<span class="badge bg-success">${r}</span>`).join(' ')
                    : '-';

                // Active status
                const statusBadge = user.active === true
                    ? '<span class="badge bg-success">Hoạt động</span>'
                    : user.active === false
                        ? '<span class="badge bg-danger">Không hoạt động</span>'
                        : '-';

                // Toggle active button
                const toggleBtn = user.active
                    ? `<button class="btn btn-sm btn-secondary" onclick="toggleActive(${user.id}, false)" title="Khóa tài khoản">
                        <i class="bi bi-lock-fill"></i>
                    </button>`
                    : `<button class="btn btn-sm btn-success" onclick="toggleActive(${user.id}, true)" title="Mở khóa">
                        <i class="bi bi-unlock-fill"></i>
                    </button>`;

                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>
                        <a href="/admin/users/${user.id}/detail?type=USER" class="text-primary text-decoration-none">
                            <strong>${user.username || '-'}</strong>
                        </a>
                    </td>
                    <td>${user.email || '-'}</td>
                    <td>${roles}</td>
                    <td>${user.departmentName || ''}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="openEditModal(${user.id})" title="Sửa">
                            <i class="bi bi-pencil"></i>
                        </button>
                        ${toggleBtn}
                        <button class="btn btn-sm btn-danger ms-1" onclick="deleteUser(${user.id})" title="Xóa">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayPagination(data) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (!data) return;

            const totalPages = data.totalPages || 0;
            const currentPage = data.number || 0;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadUsers(${currentPage - 1}); return false;">Trước</a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                if (i === 0 || i === totalPages - 1 || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="loadUsers(${i}); return false;">${i + 1}</a>`;
                    pagination.appendChild(li);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<a class="page-link" href="#">...</a>';
                    pagination.appendChild(li);
                }
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadUsers(${currentPage + 1}); return false;">Sau</a>`;
            pagination.appendChild(nextLi);
        }

        function updateStats(data) {
            if (!data) return;
            document.getElementById('totalElements').textContent = data.totalElements || 0;
            document.getElementById('currentPage').textContent = (data.number || 0) + 1;
            document.getElementById('totalPages').textContent = data.totalPages || 0;
        }

        function resetFilters() {
            document.getElementById('filterRole').value = '';
            document.getElementById('filterActive').value = '';
            document.getElementById('filterSearch').value = '';
            loadUsers(0);
        }

        // Enter key to search
        document.getElementById('filterSearch').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                loadUsers(0);
            }
        });

        // Load departments for dropdown
        function loadDepartments() {
            fetch('/api/v1/admin/departments/all')
                .then(response => response.json())
                .then(data => {
                    const departments = data.data || data;
                    // for filter dropdown
                    const filterSelect = document.getElementById('filterDepartmentId');

                    // For create modal
                    const createSelect = document.getElementById('departmentId');
                    // For edit modal
                    const editSelect = document.getElementById('editDepartmentId');

                    departments.forEach(dept => {
                        // Filter option
                        const filterOption = document.createElement('option');
                        filterOption.value = dept.id;
                        filterOption.textContent = dept.name;
                        filterSelect.appendChild(filterOption);

                        // Create option
                        const createOption = document.createElement('option');
                        createOption.value = dept.id;
                        createOption.textContent = dept.name;
                        createSelect.appendChild(createOption);

                        // Edit option
                        const editOption = document.createElement('option');
                        editOption.value = dept.id;
                        editOption.textContent = dept.name;
                        editSelect.appendChild(editOption);
                    });
                })
                .catch(error => console.error('Error loading departments:', error));
        }

        // Clear all validation errors
        function clearValidationErrors() {
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
            document.getElementById('createErrorAlert').style.display = 'none';
        }

        // Show field error
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            if (field && errorDiv) {
                field.classList.add('is-invalid');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        // Create new user
        function createUser() {
            clearValidationErrors();

            // Get selected role from radio button
            const selectedRoleElement = document.querySelector('input[name="userRole"]:checked');
            const selectedRoles = selectedRoleElement ? [parseInt(selectedRoleElement.value)] : [];

            const userData = {
                username: document.getElementById('username').value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                phone: document.getElementById('userPhone').value.trim(),
                password: document.getElementById('userPassword').value,
                address: document.getElementById('userAddress').value.trim(),
                departmentId: document.getElementById('departmentId').value || null,
                roleIds: selectedRoles,
                active: true
            };
            console.log('Creating user with data:', userData); // Debug

            // Validation
            let hasError = false;

            if (!userData.username) {
                showFieldError('username', 'Username không được để trống');
                hasError = true;
            } else if (userData.username.length < 3) {
                showFieldError('username', 'Username phải có ít nhất 3 ký tự');
                hasError = true;
            }

            if (!userData.email) {
                showFieldError('userEmail', 'Email không được để trống');
                hasError = true;
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(userData.email)) {
                showFieldError('userEmail', 'Email không hợp lệ');
                hasError = true;
            }

            if (!userData.phone) {
                showFieldError('userPhone', 'Số điện thoại không được để trống');
                hasError = true;
            } else if (!/^[0-9]{10,11}$/.test(userData.phone)) {
                showFieldError('userPhone', 'Số điện thoại phải có 10-11 chữ số');
                hasError = true;
            }

            if (!userData.password) {
                showFieldError('userPassword', 'Mật khẩu không được để trống');
                hasError = true;
            } else if (userData.password.length < 6) {
                showFieldError('userPassword', 'Mật khẩu phải có ít nhất 6 ký tự');
                hasError = true;
            }

            if (selectedRoles.length === 0) {
                showFieldError('role', 'Vui lòng chọn vai trò');
                hasError = true;
            }

            if (hasError) {
                return;
            }

            // Call API
            const errorAlert = document.getElementById('createErrorAlert');

            fetch('/api/v1/admin/users?type=USER', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            // Hiển thị lỗi trong modal
                            const errorMessage = err.message || err.error || 'Có lỗi xảy ra!';
                            errorAlert.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${errorMessage}`;
                            errorAlert.style.display = 'block';

                            // Scroll to error
                            errorAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            throw new Error('Validation failed');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
                    modal.hide();

                    // Reset form
                    document.getElementById('createUserForm').reset();
                    clearValidationErrors();

                    // Reload list
                    loadUsers(0);

                    // Show success message
                    alert('Tạo tài khoản thành công!');
                })
                .catch(error => {
                    // Lỗi đã được hiển thị trong modal ở trên
                    if (error.message !== 'Validation failed') {
                        errorAlert.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${error.message}`;
                        errorAlert.style.display = 'block';
                    }
                });
        }

        // Open edit modal and load user data
        function openEditModal(userId) {
            fetch(`/api/v1/admin/users/${userId}?type=USER`)
                .then(response => response.json())
                .then(data => {
                    const user = data.data ? data.data : data;

                    // Fill form
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editUsername').value = user.username || '';
                    document.getElementById('editEmail').value = user.email || '';
                    document.getElementById('editPhone').value = user.phone || '';
                    document.getElementById('editAddress').value = user.address || '';
                    document.getElementById('editDepartmentId').value = user.departmentId || '';
                    document.getElementById('editPassword').value = ''; // Clear password

                    // Set role
                    if (user.roles && user.roles.includes('ROLE_ADMIN')) {
                        document.getElementById('editRoleAdmin').checked = true;
                    } else {
                        document.getElementById('editRoleStaff').checked = true;
                    }

                    // Clear errors
                    clearValidationErrors();

                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    modal.show();
                })
                .catch(error => {
                    alert('Không thể tải thông tin người dùng: ' + error.message);
                });
        }

        // Update user
        function updateUser() {
            clearValidationErrors();

            const userId = document.getElementById('editUserId').value;
            const selectedRoleElement = document.querySelector('input[name="editUserRole"]:checked');
            const selectedRoles = selectedRoleElement ? [parseInt(selectedRoleElement.value)] : [];

            const userData = {
                username: document.getElementById('editUsername').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                phone: document.getElementById('editPhone').value.trim(),
                password: document.getElementById('editPassword').value, // Can be empty
                address: document.getElementById('editAddress').value.trim(),
                departmentId: document.getElementById('editDepartmentId').value || null,
                roleIds: selectedRoles,
                active: true
            };

            // Validation (similar to create)
            let hasError = false;

            if (!userData.username) {
                showFieldError('editUsername', 'Username không được để trống');
                hasError = true;
            }
            if (!userData.email) {
                showFieldError('editEmail', 'Email không được để trống');
                hasError = true;
            }
            if (!userData.phone) {
                showFieldError('editPhone', 'Số điện thoại không được để trống');
                hasError = true;
            }
            if (userData.password && userData.password.length < 6) {
                showFieldError('editPassword', 'Mật khẩu phải có ít nhất 6 ký tự');
                hasError = true;
            }
            if (selectedRoles.length === 0) {
                showFieldError('editRole', 'Vui lòng chọn vai trò');
                hasError = true;
            }

            if (hasError) return;

            const errorAlert = document.getElementById('editErrorAlert');

            fetch(`/api/v1/admin/users/${userId}?type=USER`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            const errorMessage = err.message || err.error || 'Có lỗi xảy ra!';
                            errorAlert.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${errorMessage}`;
                            errorAlert.style.display = 'block';
                            throw new Error('Validation failed');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                    modal.hide();
                    loadUsers(currentPage);
                    alert('Cập nhật thành công!');
                })
                .catch(error => {
                    if (error.message !== 'Validation failed') {
                        errorAlert.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${error.message}`;
                        errorAlert.style.display = 'block';
                    }
                });
        }

        // Toggle active status
        function toggleActive(userId, active) {
            const action = active ? 'mở khóa' : 'khóa';
            if (!confirm(`Bạn có chắc chắn muốn ${action} tài khoản này?`)) {
                return;
            }

            fetch(`/api/v1/admin/users/${userId}/toggle-active?type=USER&active=${active}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Không thể ${action} tài khoản!`);
                    }
                    alert(`${action.charAt(0).toUpperCase() + action.slice(1)} tài khoản thành công!`);
                    loadUsers(currentPage);
                })
                .catch(error => {
                    alert(error.message);
                });
        }

        // Delete user
        function deleteUser(userId) {
            if (!confirm('Bạn có chắc chắn muốn xóa người dùng này? Hành động này không thể hoàn tác!')) {
                return;
            }

            fetch(`/api/v1/admin/users/${userId}?type=USER`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Không thể xóa người dùng!');
                    }
                    alert('Xóa thành công!');
                    loadUsers(currentPage);
                })
                .catch(error => {
                    alert(error.message);
                });
        }

        // Import staff from CSV
        function importStaffFromCsv() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            const resultAlert = document.getElementById('importResultAlert');

            // Validate file selected
            if (!file) {
                alert('Vui lòng chọn file!');
                return;
            }

            // Validate file type
            if (!file.name.endsWith('.csv')) {
                alert('Chỉ chấp nhận file CSV!');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File không được vượt quá 5MB!');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // Show loading
            resultAlert.innerHTML = `
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <strong>Đang xử lý file...</strong> Vui lòng đợi.
        </div>`;
            resultAlert.style.display = 'block';

            // Disable import button
            const importBtn = event.target;
            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang import...';

            fetch('/api/v1/admin/users/import', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || 'Có lỗi xảy ra khi import!');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Import result:', data);

                    let alertClass = 'success';
                    let icon = 'check-circle-fill';
                    let title = 'Import thành công!';

                    // Build result message
                    let message = `
            <h6><strong>${title}</strong></h6>
            <div class="row text-start">
                <div class="col-4">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h4 class="text-primary mb-0">${data.total || 0}</h4>
                            <small class="text-muted">Tổng số</small>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h4 class="text-success mb-0">${data.success || 0}</h4>
                            <small class="text-muted">Thành công</small>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <h4 class="text-danger mb-0">${data.failed || 0}</h4>
                            <small class="text-muted">Thất bại</small>
                        </div>
                    </div>
                </div>
            </div>`;

                    // Show errors if any
                    if (data.errors && data.errors.length > 0) {
                        alertClass = data.success > 0 ? 'warning' : 'danger';
                        icon = 'exclamation-triangle-fill';
                        title = data.success > 0 ? 'Import hoàn tất với một số lỗi' : 'Import thất bại';

                        message += `
                <hr>
                <h6 class="text-danger"><i class="bi bi-exclamation-triangle"></i> Chi tiết lỗi:</h6>
                <div class="alert alert-danger mb-0" style="max-height: 200px; overflow-y: auto;">
                    <ol class="mb-0">`;

                        data.errors.slice(0, 20).forEach(err => {
                            message += `<li class="small">${err}</li>`;
                        });

                        if (data.errors.length > 20) {
                            message += `<li class="text-muted"><em>... và ${data.errors.length - 20} lỗi khác</em></li>`;
                        }

                        message += `</ol></div>`;
                    }

                    // Show success messages
                    if (data.successMessages && data.successMessages.length > 0 && data.successMessages.length <= 10) {
                        message += `
                <hr>
                <h6 class="text-success"><i class="bi bi-check-circle"></i> Danh sách thành công:</h6>
                <div class="alert alert-success mb-0">
                    <ol class="mb-0">`;

                        data.successMessages.forEach(msg => {
                            message += `<li class="small">${msg}</li>`;
                        });

                        message += `</ol></div>`;
                    }

                    resultAlert.innerHTML = `
            <div class="alert alert-${alertClass}">
                <i class="bi bi-${icon}"></i> ${message}
            </div>`;

                    // Reset form
                    document.getElementById('importStaffForm').reset();

                    // Reload users if any success
                    if (data.success > 0) {
                        setTimeout(() => {
                            loadUsers(0);
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Import error:', error);
                    resultAlert.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle-fill"></i> 
                <h6><strong>Có lỗi xảy ra!</strong></h6>
                <p class="mb-0">${error.message}</p>
            </div>`;
                })
                .finally(() => {
                    // Re-enable import button
                    importBtn.disabled = false;
                    importBtn.innerHTML = '<i class="bi bi-upload"></i> Import';
                });
        }

        // Download CSV template
        // Download CSV template
        function downloadTemplate() {
            const csvContent =
                `username,email,phone,address,departmentId
nguyenvana,nguyenvana@company.com,0123456789,"123 Nguyen Trai St, District 1",1
tranthib,tranthib@company.com,0987654321,"456 Le Loi St, District 3",2
levanc,levanc@company.com,0369852147,"789 Tran Hung Dao St, District 5",1
phamthid,phamthid@company.com,0912345678,"456 Hai Ba Trung St",
hoangvane,hoangvane@company.com,0901234567,"789 Le Loi St, District 1",2`;

            // Create blob with UTF-8 BOM
            const blob = new Blob(['\ufeff' + csvContent], {
                type: 'text/csv;charset=utf-8;'
            });

            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);

            link.setAttribute("href", url);
            link.setAttribute("download", "staff_import_template.csv");
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show success message
            setTimeout(() => {
                alert('✓ File mẫu đã được tải xuống!');
            }, 100);
        }
        // Clear import modal when closed
        document.getElementById('importStaffModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('importStaffForm').reset();
            document.getElementById('importResultAlert').style.display = 'none';
        });

    </script>
</body>

</html>